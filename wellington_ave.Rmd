---
title: "Wellington Greenway: Safety & Demographics Analysis"
subtitle: "Clybourn Ave to Lake Shore Drive Corridor Study"
output:
  html_document:
    output_dir: docs
    output_file: wellington_crashes.html
    toc: true
    toc_float: true
    toc_depth: 3
editor_options:
  markdown:
    wrap: 72
---

```{r setup, include=FALSE, results='hide'}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

# Load ggplot2 for theme settings
library(ggplot2)

# Set visualization themes
theme_set(theme_minimal())
custom_colors <- c("#4B0082", "#9370DB", "#e74c3c", "#3498db")
```

```{r load-data, message=FALSE, warning=FALSE, results='hide'}
# Source utility functions (which loads libraries)
source("R/utils.R")
library(sf)
library(dplyr)
library(osmdata)
library(stringr)
library(leaflet)
library(knitr)
library(kableExtra)
library(ggplot2)
library(lubridate)

# Read and process crash data
crashes <- load_crash_data("data/raw/crashes/traffic_crashes.csv")
crashes_sf <- convert_to_sf(crashes)

# Define a bounding box for Chicago and the buffer distance (150 ft ~ 45.72 m)
CHICAGO_BBOX <- c(-87.9401, 41.6445, -87.5239, 42.0230)
BUFFER_DISTANCE_M <- 45.72

# Query OSM for Wellington Ave
# Wellington runs from Clybourn Ave on the west to N Lake Shore Dr on the east
# Use tryCatch with timeout to handle intermittent API failures
wellington_query <- tryCatch({
  opq(bbox = CHICAGO_BBOX, timeout = 60) %>%
    add_osm_feature(key = 'name', value = 'West Wellington Avenue', value_exact = FALSE) %>%
    osmdata_sf()
}, error = function(e) {
  message("First attempt failed, retrying after 2 seconds...")
  Sys.sleep(2)
  opq(bbox = CHICAGO_BBOX, timeout = 60) %>%
    add_osm_feature(key = 'name', value = 'West Wellington Avenue', value_exact = FALSE) %>%
    osmdata_sf()
})

wellington_streets <- wellington_query$osm_lines %>%
  select(name, geometry) %>%
  mutate(name = "Wellington Avenue")

# Clip wellington streets at western boundary (coordinates provided by user)
# West boundary: 41.935885, -87.683119 (near Clybourn Ave)
WEST_BOUNDARY_LON <- -87.683119

# Create a bounding box from the west boundary to the eastern edge
crop_bbox <- st_bbox(c(xmin = WEST_BOUNDARY_LON,
                       ymin = 41.93,
                       xmax = -87.52,  # Eastern edge (near lake)
                       ymax = 41.94),
                     crs = st_crs(wellington_streets))

wellington_streets <- st_crop(wellington_streets, crop_bbox)

# Transform to EPSG 3857 for accurate distance calculations
wellington_streets <- sf::st_transform(wellington_streets, 3857)
crashes_sf <- sf::st_transform(crashes_sf, 3857)

# Create buffer around Wellington Ave and identify intersecting crashes
buffer <- st_buffer(wellington_streets, dist = BUFFER_DISTANCE_M)
intersects <- st_intersects(crashes_sf, buffer, sparse = FALSE)

# Filter crashes within buffer
wellington_crashes <- crashes_sf[apply(intersects, 1, any), ] %>%
  mutate(
    crash_count = 1,
    total_injuries = INJURIES_TOTAL,
    incap_injuries = INJURIES_INCAPACITATING
  )

# Load people-level data for demographic analysis
people_file <- "data/raw/people/people.csv"

if(file.exists(people_file)) {
  # Optimized reading: specify columns and types for 463MB file
  people_raw <- read_csv(
    people_file,
    col_types = cols(
      CRASH_RECORD_ID = col_character(),
      PERSON_ID = col_character(),
      PERSON_TYPE = col_character(),
      AGE = col_double(),
      SEX = col_character(),
      INJURY_CLASSIFICATION = col_character(),
      .default = col_skip()  # Skip all other columns
    )
  )

  # Join people data with wellington crashes
  wellington_people <- wellington_crashes %>%
    st_drop_geometry() %>%
    inner_join(people_raw, by = "CRASH_RECORD_ID") %>%
    mutate(
      # Clean AGE: remove invalid values (negative or > 120)
      AGE = ifelse(!is.na(AGE) & AGE >= 0 & AGE <= 120, AGE, NA),
      # Standardize SEX values
      SEX = case_when(
        SEX %in% c("M", "F") ~ SEX,
        TRUE ~ "X"  # Unknown/Not reported
      ),
      # Create Age Cohorts
      age_cohort = case_when(
        is.na(AGE) ~ "Unknown",
        AGE <= 18 ~ "Child (0-18)",
        AGE > 18 & AGE <= 29 ~ "Young Adult (19-29)",
        AGE > 29 & AGE <= 45 ~ "Adult (30-45)",
        AGE > 45 & AGE <= 65 ~ "Middle Age (46-65)",
        AGE > 65 ~ "Senior (65+)",
        TRUE ~ "Unknown"
      ),
      # Simplify Person Type
      simple_type = case_when(
        grepl("DRIVER", PERSON_TYPE) ~ "Driver",
        grepl("PASSENGER", PERSON_TYPE) ~ "Passenger",
        grepl("PEDESTRIAN", PERSON_TYPE) ~ "Pedestrian",
        grepl("BICYCLE", PERSON_TYPE) ~ "Cyclist",
        TRUE ~ "Other"
      ),
      # Hour of day
      crash_hour = hour(CRASH_DATE)
    )
} else {
  warning("People data file not found. Demographic analysis will be skipped.")
  wellington_people <- NULL
}
```

## Project Context

The Chicago Department of Transportation (CDOT) is proposing a **Neighborhood Greenway** on Wellington Avenue, connecting the Leavitt Greenway to the Lakefront Trail. This infrastructure is designed to be a "family-friendly" route, providing critical access to Hamlin Park, Nettelhorst School, and the Wellington CTA station.

**Key proposed features include:**

- **Advisory Bike Lanes** to encourage safer passing
- **Contraflow Lanes** to allow legal two-way cycling on one-way streets
- **Lowered Speed Limits** (20 mph) to improve safety for all road users

This analysis examines crash history specifically within the project boundaries: **Clybourn Avenue (West) to N Lake Shore Drive (East)**.

Data for this analysis is sourced from the [Traffic Crashes](https://data.cityofchicago.org/Transportation/Traffic-Crashes-Crashes/85ca-t3if/about_data) and [Traffic Crashes - People](https://data.cityofchicago.org/Transportation/Traffic-Crashes-People/u6pd-qa9d) datasets from the Chicago City Data Portal.

## Study Area Map

The map below highlights the specific corridor analyzed (purple line) and the 150ft buffer zone used to capture crashes impacting the street:

```{r buffer-visualization, fig.width=10, fig.height=6}
# Transform to WGS84 for visualization
wellington_streets_4326 <- st_transform(wellington_streets, 4326)
buffer_4326 <- st_transform(buffer, 4326)

# Create visualization of the buffer
buffer_map <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolylines(
    data = wellington_streets_4326,
    color = "#4B0082",
    weight = 3,
    label = "Wellington Avenue"
  ) %>%
  addPolygons(
    data = buffer_4326,
    fillColor = "#9370DB",
    fillOpacity = 0.3,
    color = "#4B0082",
    weight = 2,
    label = "150ft Buffer Zone"
  ) %>%
  setView(lng = -87.6505, lat = 41.9362, zoom = 14)

buffer_map
```

## Demographics: Who is Involved?

Understanding the age of people involved in crashes helps assess the need for "family-friendly" infrastructure.

### Age Distribution of People Involved in Crashes

The chart below shows the age groups of all individuals involved in crashes on this corridor (drivers, passengers, cyclists, and pedestrians).

```{r demographics-age, fig.width=10, fig.height=6}
if(!is.null(wellington_people)) {
  age_stats <- wellington_people %>%
    filter(age_cohort != "Unknown") %>%
    count(age_cohort, simple_type)

  ggplot(age_stats, aes(x = age_cohort, y = n, fill = simple_type)) +
    geom_bar(stat = "identity") +
    scale_fill_manual(values = c("Driver"="#95a5a6", "Passenger"="#34495e",
                                  "Cyclist"="#e74c3c", "Pedestrian"="#3498db",
                                  "Other"="#bdc3c7")) +
    labs(
      title = "Age Distribution of People Involved in Crashes",
      subtitle = "Wellington Ave (Clybourn to Lake Shore Drive)",
      x = "Age Group",
      y = "Number of People",
      fill = "Person Type"
    ) +
    theme(legend.position = "bottom")
}
```

### Focus on Children (Ages 0-18)

```{r demographics-children}
if(!is.null(wellington_people)) {
  child_crashes <- wellington_people %>% filter(age_cohort == "Child (0-18)")
  child_count <- nrow(child_crashes)
  child_ped_bike <- child_crashes %>%
    filter(simple_type %in% c("Pedestrian", "Cyclist")) %>%
    nrow()

  cat(paste0("There have been **", child_count,
             " children** (under 18) involved in crashes on this corridor since 2019. ",
             "Of those, **", child_ped_bike, " were walking or biking**."))
}
```

## Temporal Analysis: When Do Crashes Happen?

Analyzing crash times helps us understand if students are at risk during school commute hours.

### All Crashes by Hour of Day

Crashes generally peak during the evening rush hour, but a consistent baseline exists throughout the day.

```{r temporal-all-crashes, fig.width=12, fig.height=6}
time_stats <- wellington_crashes %>%
  st_drop_geometry() %>%
  mutate(hour = hour(CRASH_DATE)) %>%
  count(hour)

ggplot(time_stats, aes(x = hour, y = n)) +
  geom_line(color = "#2c3e50", size = 1) +
  geom_area(fill = "#2c3e50", alpha = 0.1) +
  scale_x_continuous(
    breaks = 0:23,
    labels = function(x) {
      ifelse(x == 0, "12am",
      ifelse(x < 12, paste0(x, "am"),
      ifelse(x == 12, "12pm",
             paste0(x - 12, "pm"))))
    }
  ) +
  labs(
    title = "Total Crash Frequency by Hour of Day",
    x = "Time of Day",
    y = "Number of Crashes"
  )
```

### Children Involved in Crashes by Hour

The chart below isolates crashes involving children (ages 0-18). Note the spikes that align with school commute times.

```{r temporal-children, fig.width=12, fig.height=6}
if(!is.null(wellington_people)) {
  # Filter specifically for kids
  child_time_stats <- wellington_people %>%
    filter(age_cohort == "Child (0-18)") %>%
    count(crash_hour, simple_type)

  # Define school hours for highlighting
  school_morning <- data.frame(xmin=7, xmax=9, ymin=0, ymax=Inf)
  school_afternoon <- data.frame(xmin=14, xmax=16, ymin=0, ymax=Inf)

  ggplot() +
    # Highlight school commute times
    geom_rect(data=school_morning, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax),
              fill="#f1c40f", alpha=0.2) +
    geom_rect(data=school_afternoon, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax),
              fill="#f1c40f", alpha=0.2) +
    # Bar chart of incidents
    geom_bar(data = child_time_stats, aes(x = crash_hour, y = n, fill = simple_type),
             stat="identity") +
    scale_fill_manual(values = c("Driver"="#95a5a6", "Passenger"="#34495e",
                                  "Cyclist"="#e74c3c", "Pedestrian"="#3498db",
                                  "Other"="#bdc3c7")) +
    scale_x_continuous(
      breaks = 0:23,
      labels = function(x) {
        ifelse(x == 0, "12am",
        ifelse(x < 12, paste0(x, "am"),
        ifelse(x == 12, "12pm",
               paste0(x - 12, "pm"))))
      }
    ) +
    labs(
      title = "Children Involved in Crashes by Hour",
      subtitle = "Yellow highlights indicate typical school commute times (7-9am, 2-4pm)",
      x = "Time of Day",
      y = "Number of Children Involved",
      fill = "Mode of Transport"
    ) +
    annotate("text", x = 8, y = max(child_time_stats$n) * 1.1,
             label = "Morning\nCommute", size = 3) +
    annotate("text", x = 15, y = max(child_time_stats$n) * 1.1,
             label = "School\nDismissal", size = 3) +
    theme(legend.position = "bottom")
}
```

## General Safety Summary

```{r crash-stats}
# Calculate overall statistics
total_crashes <- nrow(wellington_crashes)
total_injuries <- sum(wellington_crashes$INJURIES_TOTAL, na.rm = TRUE)

# Create cyclist and pedestrian crash datasets for later use
cyclist_crashes <- wellington_crashes %>%
  filter(grepl("PEDALCYCLIST|BICYCL", FIRST_CRASH_TYPE, ignore.case = TRUE))

pedestrian_crashes <- wellington_crashes %>%
  filter(grepl("PEDESTRIAN", FIRST_CRASH_TYPE, ignore.case = TRUE))

# Counts for summary
ped_crashes <- nrow(pedestrian_crashes)
bike_crashes <- nrow(cyclist_crashes)
```

In the corridor from Clybourn to Lake Shore Drive (2019-Present):

- **`r formatC(total_crashes, big.mark=",")` Total reported crashes**
- **`r formatC(total_injuries, big.mark=",")` Total injuries reported**
- **`r formatC(bike_crashes, big.mark=",")` crashes involved a cyclist**
- **`r formatC(ped_crashes, big.mark=",")` crashes involved a pedestrian**

### High Injury Locations

This map shows where injuries (of any type) are most concentrated.

```{r injury-hotspots, fig.width=10, fig.height=6}
# Filter for crashes with injuries
injury_crashes <- wellington_crashes %>%
  filter(INJURIES_TOTAL > 0) %>%
  st_transform(4326)

wellington_streets_4326 <- st_transform(wellington_streets, 4326)

leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolylines(
    data = wellington_streets_4326,
    color = "#666666",
    weight = 3
  ) %>%
  addCircleMarkers(
    data = injury_crashes,
    radius = ~INJURIES_TOTAL * 3,
    color = "#e74c3c",
    stroke = FALSE,
    fillOpacity = 0.6,
    label = ~paste0("Injuries: ", INJURIES_TOTAL, " (", format(CRASH_DATE, "%Y"), ")")
  ) %>%
  addLegend(position = "bottomright", colors = "#e74c3c", labels = "Injury Crash") %>%
  setView(lng = -87.658, lat = 41.9362, zoom = 14)
```

## Cyclist Crash Locations

This map shows all crashes involving cyclists along the Wellington Avenue corridor.

```{r cyclist-map, fig.width=10, fig.height=6}
# Transform cyclist crashes to WGS84 for mapping
cyclist_crashes_4326 <- st_transform(cyclist_crashes, 4326)
wellington_streets_4326 <- st_transform(wellington_streets, 4326)

# Create cyclist crash map
cyclist_map <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolylines(
    data = wellington_streets_4326,
    color = "#666666",
    weight = 3,
    label = "Wellington Avenue"
  ) %>%
  addCircleMarkers(
    data = cyclist_crashes_4326,
    radius = 5,
    color = "#e74c3c",
    fillColor = "#e74c3c",
    fillOpacity = 0.7,
    stroke = TRUE,
    weight = 1,
    label = ~paste0(
      "Crash Date: ", format(CRASH_DATE, "%Y-%m-%d"), "<br>",
      "Injuries: ", INJURIES_TOTAL, "<br>",
      "Type: ", FIRST_CRASH_TYPE
    ) %>% lapply(htmltools::HTML)
  ) %>%
  addLegend(
    position = "bottomright",
    colors = "#e74c3c",
    labels = "Cyclist Crash",
    title = "Legend"
  ) %>%
  setView(lng = -87.6505, lat = 41.9362, zoom = 14)

cyclist_map
```

## Pedestrian Crash Locations

This map shows all crashes involving pedestrians along the Wellington Avenue corridor.

```{r pedestrian-map, fig.width=10, fig.height=6}
# Transform pedestrian crashes to WGS84 for mapping
pedestrian_crashes_4326 <- st_transform(pedestrian_crashes, 4326)

# Create pedestrian crash map
pedestrian_map <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolylines(
    data = wellington_streets_4326,
    color = "#666666",
    weight = 3,
    label = "Wellington Avenue"
  ) %>%
  addCircleMarkers(
    data = pedestrian_crashes_4326,
    radius = 5,
    color = "#3498db",
    fillColor = "#3498db",
    fillOpacity = 0.7,
    stroke = TRUE,
    weight = 1,
    label = ~paste0(
      "Crash Date: ", format(CRASH_DATE, "%Y-%m-%d"), "<br>",
      "Injuries: ", INJURIES_TOTAL, "<br>",
      "Type: ", FIRST_CRASH_TYPE
    ) %>% lapply(htmltools::HTML)
  ) %>%
  addLegend(
    position = "bottomright",
    colors = "#3498db",
    labels = "Pedestrian Crash",
    title = "Legend"
  ) %>%
  setView(lng = -87.6505, lat = 41.9362, zoom = 14)

pedestrian_map
```

## Crash Clusters

This heat map visualization shows where crashes are concentrated along the Wellington Avenue corridor.

```{r crash-clusters, fig.width=10, fig.height=6}
# Transform crashes to WGS84 for mapping
wellington_crashes_4326 <- st_transform(wellington_crashes, 4326)

# Create hex grid for crash clustering
bbox_utm <- st_transform(st_as_sfc(st_bbox(wellington_crashes_4326)), 26916)

hex_grid <- st_make_grid(
  bbox_utm,
  cellsize = c(150, 150),  # 150 meter hexagons
  square = FALSE
) %>%
  st_sf() %>%
  st_transform(4326)

# Calculate crash counts per hexagon
hex_sf <- hex_grid %>%
  mutate(
    count = lengths(st_intersects(., wellington_crashes_4326)),
    total_injuries = sapply(st_intersects(., wellington_crashes_4326), function(idx) {
      sum(wellington_crashes_4326$INJURIES_TOTAL[idx], na.rm = TRUE)
    })
  ) %>%
  filter(count > 0)

# Color palette
pal <- colorNumeric(
  palette = "YlOrRd",
  domain = hex_sf$count
)

# Create the map
cluster_map <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolylines(
    data = wellington_streets_4326,
    color = "#666666",
    weight = 3,
    label = "Wellington Avenue"
  ) %>%
  addPolygons(
    data = hex_sf,
    fillColor = ~pal(count),
    fillOpacity = 0.7,
    color = "#FFFFFF",
    weight = 1,
    label = ~sprintf(
      "%d crashes<br>%d injuries",
      count,
      total_injuries
    ) %>% lapply(htmltools::HTML),
    highlightOptions = highlightOptions(
      weight = 2,
      color = "#666",
      fillOpacity = 0.9,
      bringToFront = TRUE
    )
  ) %>%
  addLegend(
    position = "bottomright",
    pal = pal,
    values = hex_sf$count,
    title = "Crash Count",
    opacity = 0.7
  ) %>%
  setView(lng = -87.6505, lat = 41.9362, zoom = 14)

cluster_map
```
