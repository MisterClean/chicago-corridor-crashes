---
title: "Wellington Greenway: Crash Analysis"
subtitle: "Corridor Study by Lakeview Urbanists"
output:
  html_document:
    output_dir: docs
    output_file: wellington_crashes.html
editor_options:
  markdown:
    wrap: 72
---

```{r setup, include=FALSE, results='hide'}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

# Load ggplot2 for theme settings
library(ggplot2)

# Set visualization themes
theme_set(theme_minimal())
custom_colors <- c("#4B0082", "#9370DB", "#e74c3c", "#3498db")
```

```{r load-data, message=FALSE, warning=FALSE, results='hide'}
# Source utility functions (which loads libraries)
source("R/utils.R")
library(sf)
library(dplyr)
library(osmdata)
library(stringr)
library(leaflet)
library(knitr)
library(kableExtra)
library(ggplot2)
library(lubridate)

# Read and process crash data
crashes <- load_crash_data("data/raw/crashes/traffic_crashes.csv")
crashes_sf <- convert_to_sf(crashes)

# Define a bounding box for Chicago and the buffer distance (150 ft ~ 45.72 m)
CHICAGO_BBOX <- c(-87.9401, 41.6445, -87.5239, 42.0230)
BUFFER_DISTANCE_M <- 45.72

# Query OSM for Wellington Ave
# Wellington runs from Clybourn Ave on the west to N Lake Shore Dr on the east
# Use tryCatch with timeout to handle intermittent API failures
wellington_query <- tryCatch({
  opq(bbox = CHICAGO_BBOX, timeout = 60) %>%
    add_osm_feature(key = 'name', value = 'West Wellington Avenue', value_exact = FALSE) %>%
    osmdata_sf()
}, error = function(e) {
  message("First attempt failed, retrying after 2 seconds...")
  Sys.sleep(2)
  opq(bbox = CHICAGO_BBOX, timeout = 60) %>%
    add_osm_feature(key = 'name', value = 'West Wellington Avenue', value_exact = FALSE) %>%
    osmdata_sf()
})

wellington_streets <- wellington_query$osm_lines %>%
  select(name, geometry) %>%
  mutate(name = "Wellington Avenue")

# Clip wellington streets at western boundary (coordinates provided by user)
# West boundary: 41.935885, -87.683119 (near Clybourn Ave)
WEST_BOUNDARY_LON <- -87.683119

# Create a bounding box from the west boundary to the eastern edge
crop_bbox <- st_bbox(c(xmin = WEST_BOUNDARY_LON,
                       ymin = 41.93,
                       xmax = -87.52,  # Eastern edge (near lake)
                       ymax = 41.94),
                     crs = st_crs(wellington_streets))

wellington_streets <- st_crop(wellington_streets, crop_bbox)

# Transform to EPSG 3857 for accurate distance calculations
wellington_streets <- sf::st_transform(wellington_streets, 3857)
crashes_sf <- sf::st_transform(crashes_sf, 3857)

# Create buffer around Wellington Ave and identify intersecting crashes
buffer <- st_buffer(wellington_streets, dist = BUFFER_DISTANCE_M)
intersects <- st_intersects(crashes_sf, buffer, sparse = FALSE)

# Filter crashes within buffer
wellington_crashes <- crashes_sf[apply(intersects, 1, any), ] %>%
  mutate(
    crash_count = 1,
    total_injuries = INJURIES_TOTAL,
    incap_injuries = INJURIES_INCAPACITATING
  )

# Load people-level data for demographic analysis
people_file <- "data/raw/people/people.csv"

if(file.exists(people_file)) {
  # Optimized reading: specify columns and types for 463MB file
  people_raw <- read_csv(
    people_file,
    col_types = cols(
      CRASH_RECORD_ID = col_character(),
      PERSON_ID = col_character(),
      PERSON_TYPE = col_character(),
      AGE = col_double(),
      SEX = col_character(),
      INJURY_CLASSIFICATION = col_character(),
      .default = col_skip()  # Skip all other columns
    )
  )

  # Join people data with wellington crashes
  wellington_people <- wellington_crashes %>%
    st_drop_geometry() %>%
    inner_join(people_raw, by = "CRASH_RECORD_ID") %>%
    mutate(
      # Clean AGE: remove invalid values (negative or > 120)
      AGE = ifelse(!is.na(AGE) & AGE >= 0 & AGE <= 120, AGE, NA),
      # Standardize SEX values
      SEX = case_when(
        SEX %in% c("M", "F") ~ SEX,
        TRUE ~ "X"  # Unknown/Not reported
      ),
      # Create Age Cohorts (ordered factor for proper chart ordering)
      age_cohort = case_when(
        is.na(AGE) ~ "Unknown",
        AGE <= 18 ~ "Child (0-18)",
        AGE > 18 & AGE <= 29 ~ "Young Adult (19-29)",
        AGE > 29 & AGE <= 45 ~ "Adult (30-45)",
        AGE > 45 & AGE <= 65 ~ "Middle Age (46-65)",
        AGE > 65 ~ "Senior (65+)",
        TRUE ~ "Unknown"
      ),
      age_cohort = factor(age_cohort, levels = c(
        "Child (0-18)",
        "Young Adult (19-29)",
        "Adult (30-45)",
        "Middle Age (46-65)",
        "Senior (65+)",
        "Unknown"
      )),
      # Simplify Person Type
      simple_type = case_when(
        grepl("DRIVER", PERSON_TYPE) ~ "Driver",
        grepl("PASSENGER", PERSON_TYPE) ~ "Passenger",
        grepl("PEDESTRIAN", PERSON_TYPE) ~ "Pedestrian",
        grepl("BICYCLE", PERSON_TYPE) ~ "Cyclist",
        TRUE ~ "Other"
      ),
      # Hour of day
      crash_hour = hour(CRASH_DATE)
    )
} else {
  warning("People data file not found. Demographic analysis will be skipped.")
  wellington_people <- NULL
}
```

## Project Context

The Chicago Department of Transportation (CDOT) is proposing a **Neighborhood Greenway** on [Wellington Avenue](https://api.chicago.gov/filenet5/servlets/getDocumentContent?applicationId=CompleteStreets&documentId=%7BF0FB4197-0000-CD1D-9EA2-EC8C11B1EB46%7D), connecting the Leavitt Greenway to the Lakefront Trail. This proposed infrastructure is intended to be a family-friendly route, providing access to Hamlin Park, Alphonsus Academy, Wellington CTA station, and the lakefront.

**Key proposed features include:**

- **Advisory Bike Lanes** to encourage safer passing
- **Contraflow Lanes** to allow legal two-way cycling on one-way streets
- **Lowered Speed Limits** (20 mph) to improve safety for all road users

This analysis examines crash history specifically within the project boundaries: **Clybourn Avenue (West) to N Lake Shore Drive (East)**.

Data for this analysis is sourced from the [Traffic Crashes](https://data.cityofchicago.org/Transportation/Traffic-Crashes-Crashes/85ca-t3if/about_data) and [Traffic Crashes - People](https://data.cityofchicago.org/Transportation/Traffic-Crashes-People/u6pd-qa9d) datasets from the Chicago City Data Portal. This report was made by the [Lakeview Urbanists](https://lakeviewurbanists.com/). Signup for our newsletter to stay informed about advocacy opportunities for cycling infrastructure like this!

## Study Area Map

The map below highlights the specific corridor analyzed (purple line) and the 150ft buffer zone used to capture crashes impacting the street:

```{r buffer-visualization, fig.width=10, fig.height=6}
# Transform to WGS84 for visualization
wellington_streets_4326 <- st_transform(wellington_streets, 4326)
buffer_4326 <- st_transform(buffer, 4326)

# Create visualization of the buffer
buffer_map <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolylines(
    data = wellington_streets_4326,
    color = "#4B0082",
    weight = 3,
    label = "Wellington Avenue"
  ) %>%
  addPolygons(
    data = buffer_4326,
    fillColor = "#9370DB",
    fillOpacity = 0.3,
    color = "#4B0082",
    weight = 2,
    label = "150ft Buffer Zone"
  ) %>%
  setView(lng = -87.6505, lat = 41.9362, zoom = 14)

buffer_map
```

## Demographics: Who is Involved?

Understanding the age of people involved in crashes helps assess the need for "family-friendly" infrastructure.

### Age Distribution of People Involved in Crashes

The chart below shows the age groups of all individuals involved in crashes on this corridor (drivers, passengers, cyclists, and pedestrians).

```{r demographics-age, fig.width=10, fig.height=6}
if(!is.null(wellington_people)) {
  age_stats <- wellington_people %>%
    filter(age_cohort != "Unknown") %>%
    count(age_cohort, simple_type)

  ggplot(age_stats, aes(x = age_cohort, y = n, fill = simple_type)) +
    geom_bar(stat = "identity") +
    scale_fill_manual(values = c("Driver"="#95a5a6", "Passenger"="#34495e",
                                  "Cyclist"="#e74c3c", "Pedestrian"="#3498db",
                                  "Other"="#bdc3c7")) +
    labs(
      title = "Age Distribution of People Involved in Crashes",
      subtitle = "Wellington Ave (Clybourn to Lake Shore Drive) | Data: 2019-2024",
      x = "Age Group",
      y = "Number of People",
      fill = "Person Type"
    ) +
    theme(legend.position = "bottom")
}
```

### Focus on Children (Ages 0-18)

```{r demographics-children}
if(!is.null(wellington_people)) {
  child_crashes <- wellington_people %>% filter(age_cohort == "Child (0-18)")
  child_count <- nrow(child_crashes)
  child_ped_bike <- child_crashes %>%
    filter(simple_type %in% c("Pedestrian", "Cyclist")) %>%
    nrow()

  cat(paste0("There have been **", child_count,
             " children** (under 18) involved in crashes on this corridor (2019-2024). ",
             "Of those, **", child_ped_bike, " were walking or biking**."))
}
```

## Temporal Analysis: When Do Crashes Happen?

Analyzing crash times helps us understand if students are at risk during school commute hours.

### All Crashes by Hour of Day

Crashes generally peak during the evening rush hour, but a consistent baseline exists throughout the day.

```{r temporal-all-crashes, fig.width=12, fig.height=6}
time_stats <- wellington_crashes %>%
  st_drop_geometry() %>%
  mutate(hour = hour(CRASH_DATE)) %>%
  count(hour)

ggplot(time_stats, aes(x = hour, y = n)) +
  geom_line(color = "#2c3e50", size = 1) +
  geom_area(fill = "#2c3e50", alpha = 0.1) +
  scale_x_continuous(
    breaks = 0:23,
    labels = function(x) {
      ifelse(x == 0, "12am",
      ifelse(x < 12, paste0(x, "am"),
      ifelse(x == 12, "12pm",
             paste0(x - 12, "pm"))))
    }
  ) +
  labs(
    title = "Total Crash Frequency by Hour of Day",
    subtitle = "Data: 2019-2024",
    x = "Time of Day",
    y = "Number of Crashes"
  )
```

### Children Involved in Crashes by Hour

The chart below isolates crashes involving children (ages 0-18). Note the spikes that align with school commute times.

```{r temporal-children, fig.width=12, fig.height=6}
if(!is.null(wellington_people)) {
  # Filter specifically for kids
  child_time_stats <- wellington_people %>%
    filter(age_cohort == "Child (0-18)") %>%
    count(crash_hour, simple_type)

  # Define school hours for highlighting
  school_morning <- data.frame(xmin=7, xmax=9, ymin=0, ymax=Inf)
  school_afternoon <- data.frame(xmin=14, xmax=16, ymin=0, ymax=Inf)

  ggplot() +
    # Highlight school commute times
    geom_rect(data=school_morning, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax),
              fill="#f1c40f", alpha=0.2) +
    geom_rect(data=school_afternoon, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax),
              fill="#f1c40f", alpha=0.2) +
    # Bar chart of incidents
    geom_bar(data = child_time_stats, aes(x = crash_hour, y = n, fill = simple_type),
             stat="identity") +
    scale_fill_manual(values = c("Driver"="#95a5a6", "Passenger"="#34495e",
                                  "Cyclist"="#e74c3c", "Pedestrian"="#3498db",
                                  "Other"="#bdc3c7")) +
    scale_x_continuous(
      breaks = 0:23,
      labels = function(x) {
        ifelse(x == 0, "12am",
        ifelse(x < 12, paste0(x, "am"),
        ifelse(x == 12, "12pm",
               paste0(x - 12, "pm"))))
      }
    ) +
    labs(
      title = "Children Involved in Crashes by Hour",
      subtitle = "Yellow highlights indicate typical school commute times (7-9am, 2-4pm) | Data: 2019-2024",
      x = "Time of Day",
      y = "Number of Children Involved",
      fill = "Mode of Transport"
    ) +
    annotate("text", x = 8, y = max(child_time_stats$n) * 1.1,
             label = "Morning\nCommute", size = 3) +
    annotate("text", x = 15, y = max(child_time_stats$n) * 1.1,
             label = "School\nDismissal", size = 3) +
    theme(legend.position = "bottom")
}
```

## Seasonal Analysis

Understanding how crashes vary by season helps identify whether weather conditions, seasonal travel patterns, or other factors influence road safety along the corridor.

```{r seasonal-data-prep}
# Add season categorization to crash data
wellington_crashes_seasonal <- wellington_crashes %>%
  st_drop_geometry() %>%
  mutate(
    month = month(CRASH_DATE),
    season = case_when(
      month %in% c(12, 1, 2) ~ "Winter",
      month %in% c(3, 4, 5) ~ "Spring",
      month %in% c(6, 7, 8) ~ "Summer",
      month %in% c(9, 10, 11) ~ "Fall"
    ),
    season = factor(season, levels = c("Winter", "Spring", "Summer", "Fall")),
    year = year(CRASH_DATE)
  )

# Calculate seasonal statistics
seasonal_stats <- wellington_crashes_seasonal %>%
  group_by(season) %>%
  summarise(
    total_crashes = n(),
    total_injuries = sum(INJURIES_TOTAL, na.rm = TRUE),
    incapacitating_injuries = sum(INJURIES_INCAPACITATING, na.rm = TRUE),
    fatal_injuries = sum(INJURIES_FATAL, na.rm = TRUE),
    .groups = "drop"
  )

# Vulnerable users by season
cyclist_seasonal <- wellington_crashes_seasonal %>%
  filter(grepl("PEDALCYCLIST|BICYCL", FIRST_CRASH_TYPE, ignore.case = TRUE)) %>%
  group_by(season) %>%
  summarise(cyclist_crashes = n(), .groups = "drop")

pedestrian_seasonal <- wellington_crashes_seasonal %>%
  filter(grepl("PEDESTRIAN", FIRST_CRASH_TYPE, ignore.case = TRUE)) %>%
  group_by(season) %>%
  summarise(pedestrian_crashes = n(), .groups = "drop")

vulnerable_seasonal <- seasonal_stats %>%
  left_join(cyclist_seasonal, by = "season") %>%
  left_join(pedestrian_seasonal, by = "season") %>%
  mutate(
    cyclist_crashes = replace_na(cyclist_crashes, 0),
    pedestrian_crashes = replace_na(pedestrian_crashes, 0)
  )
```

### Total Crashes by Season

This chart shows the overall distribution of crashes across the four seasons (Data: 2019-2024).

```{r seasonal-crashes, fig.width=10, fig.height=6}
ggplot(seasonal_stats, aes(x = season, y = total_crashes, fill = season)) +
  geom_bar(stat = "identity", alpha = 0.8) +
  geom_text(aes(label = total_crashes), vjust = -0.5, size = 4, fontface = "bold") +
  scale_fill_manual(values = c(
    "Winter" = "#3498db",   # Blue
    "Spring" = "#2ecc71",   # Green
    "Summer" = "#f39c12",   # Orange
    "Fall" = "#e67e22"      # Dark orange
  )) +
  labs(
    title = "Total Crashes by Season",
    subtitle = "Wellington Ave (Clybourn to Lake Shore Drive) | Data: 2019-2024",
    x = "Season",
    y = "Number of Crashes"
  ) +
  theme(legend.position = "none")
```

### Injuries by Season

This breakdown shows how injury severity varies across seasons.

```{r seasonal-injuries, fig.width=10, fig.height=6}
# Reshape data for stacked bar chart
injury_seasonal_long <- seasonal_stats %>%
  select(season, total_injuries, incapacitating_injuries, fatal_injuries) %>%
  mutate(
    non_incap_injuries = total_injuries - incapacitating_injuries - fatal_injuries
  ) %>%
  select(season, non_incap_injuries, incapacitating_injuries, fatal_injuries) %>%
  tidyr::pivot_longer(
    cols = c(non_incap_injuries, incapacitating_injuries, fatal_injuries),
    names_to = "injury_type",
    values_to = "count"
  ) %>%
  mutate(
    injury_type = factor(injury_type,
      levels = c("fatal_injuries", "incapacitating_injuries", "non_incap_injuries"),
      labels = c("Fatal", "Incapacitating", "Other Injuries")
    )
  )

ggplot(injury_seasonal_long, aes(x = season, y = count, fill = injury_type)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c(
    "Fatal" = "#c0392b",
    "Incapacitating" = "#e74c3c",
    "Other Injuries" = "#f8b739"
  )) +
  labs(
    title = "Injuries by Season and Severity",
    subtitle = "Wellington Ave (Clybourn to Lake Shore Drive) | Data: 2019-2024",
    x = "Season",
    y = "Number of Injuries",
    fill = "Injury Type"
  ) +
  theme(legend.position = "bottom")
```

### Vulnerable Road Users by Season

Cyclist and pedestrian crashes show distinct seasonal patterns, often influenced by weather and travel mode choices.

```{r seasonal-vulnerable, fig.width=10, fig.height=6}
# Reshape for grouped bar chart
vulnerable_long <- vulnerable_seasonal %>%
  select(season, cyclist_crashes, pedestrian_crashes) %>%
  tidyr::pivot_longer(
    cols = c(cyclist_crashes, pedestrian_crashes),
    names_to = "user_type",
    values_to = "crashes"
  ) %>%
  mutate(
    user_type = factor(user_type,
      levels = c("cyclist_crashes", "pedestrian_crashes"),
      labels = c("Cyclists", "Pedestrians")
    )
  )

ggplot(vulnerable_long, aes(x = season, y = crashes, fill = user_type)) +
  geom_bar(stat = "identity", position = "dodge", alpha = 0.8) +
  geom_text(aes(label = crashes), position = position_dodge(width = 0.9),
            vjust = -0.5, size = 3.5) +
  scale_fill_manual(values = c("Cyclists" = "#e74c3c", "Pedestrians" = "#3498db")) +
  labs(
    title = "Vulnerable Road User Crashes by Season",
    subtitle = "Wellington Ave (Clybourn to Lake Shore Drive) | Data: 2019-2024",
    x = "Season",
    y = "Number of Crashes",
    fill = "User Type"
  ) +
  theme(legend.position = "bottom")
```

### Seasonal Summary Statistics

The table below provides a comprehensive overview of crashes, injuries, and vulnerable user involvement across all four seasons (Data: 2019-2024).

```{r seasonal-summary-table, results='asis'}
seasonal_table <- vulnerable_seasonal %>%
  mutate(
    avg_crashes_per_month = round(total_crashes / 3, 1),
    injury_rate = paste0(round((total_injuries / total_crashes) * 100, 1), "%")
  ) %>%
  select(
    Season = season,
    `Total Crashes` = total_crashes,
    `Avg/Month` = avg_crashes_per_month,
    `Total Injuries` = total_injuries,
    `Injury Rate` = injury_rate,
    `Cyclist Crashes` = cyclist_crashes,
    `Pedestrian Crashes` = pedestrian_crashes
  )

kable(seasonal_table,
      format = "html",
      align = c("l", "r", "r", "r", "r", "r", "r")) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "left"
  ) %>%
  row_spec(0, bold = TRUE, background = "#4B0082", color = "white") %>%
  column_spec(1, bold = TRUE, width = "8em") %>%
  column_spec(2:7, width = "7em")
```

## General Safety Summary

```{r crash-stats}
# Calculate overall statistics
total_crashes <- nrow(wellington_crashes)
total_injuries <- sum(wellington_crashes$INJURIES_TOTAL, na.rm = TRUE)

# Create cyclist and pedestrian crash datasets for later use
cyclist_crashes <- wellington_crashes %>%
  filter(grepl("PEDALCYCLIST|BICYCL", FIRST_CRASH_TYPE, ignore.case = TRUE))

pedestrian_crashes <- wellington_crashes %>%
  filter(grepl("PEDESTRIAN", FIRST_CRASH_TYPE, ignore.case = TRUE))

# Counts for summary
ped_crashes <- nrow(pedestrian_crashes)
bike_crashes <- nrow(cyclist_crashes)

# Aggregate person-level data for enhanced tooltips
if(!is.null(wellington_people)) {
  crash_people_summary <- wellington_people %>%
    group_by(CRASH_RECORD_ID) %>%
    summarise(
      num_people = n(),
      num_drivers = sum(simple_type == "Driver", na.rm = TRUE),
      num_passengers = sum(simple_type == "Passenger", na.rm = TRUE),
      num_cyclists = sum(simple_type == "Cyclist", na.rm = TRUE),
      num_pedestrians = sum(simple_type == "Pedestrian", na.rm = TRUE),
      num_other = sum(simple_type == "Other", na.rm = TRUE),
      age_min = min(AGE, na.rm = TRUE),
      age_max = max(AGE, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    mutate(
      # Format age range for display
      age_range = case_when(
        is.infinite(age_min) ~ "Unknown",
        age_min == age_max ~ as.character(age_min),
        TRUE ~ paste0(age_min, "-", age_max)
      ),
      # Create people summary text
      people_summary = paste0(
        if_else(num_drivers > 0, paste0(num_drivers, " driver", if_else(num_drivers > 1, "s", "")), ""),
        if_else(num_passengers > 0,
                paste0(if_else(num_drivers > 0, ", ", ""), num_passengers, " passenger", if_else(num_passengers > 1, "s", "")), ""),
        if_else(num_cyclists > 0,
                paste0(if_else(num_drivers > 0 | num_passengers > 0, ", ", ""), num_cyclists, " cyclist", if_else(num_cyclists > 1, "s", "")), ""),
        if_else(num_pedestrians > 0,
                paste0(if_else(num_drivers > 0 | num_passengers > 0 | num_cyclists > 0, ", ", ""),
                       num_pedestrians, " pedestrian", if_else(num_pedestrians > 1, "s", "")), ""),
        if_else(num_other > 0,
                paste0(if_else(num_drivers > 0 | num_passengers > 0 | num_cyclists > 0 | num_pedestrians > 0, ", ", ""),
                       num_other, " other"), "")
      )
    )
} else {
  crash_people_summary <- NULL
}
```

In the corridor from Clybourn to Lake Shore Drive (2019-2024):

- **`r formatC(total_crashes, big.mark=",")` Total reported crashes**
- **`r formatC(total_injuries, big.mark=",")` Total injuries reported**
- **`r formatC(bike_crashes, big.mark=",")` crashes involved a cyclist**
- **`r formatC(ped_crashes, big.mark=",")` crashes involved a pedestrian**

## Detailed Crash Statistics

The following tables provide a comprehensive breakdown of crash severity, vulnerable road users, and impacts on children in the corridor.

```{r summary-stats-calc}
# Calculate detailed summary statistics for tables

# Table 1: Overall Crash Summary
if(!is.null(wellington_people)) {
  overall_stats <- data.frame(
    Metric = c(
      "Total Crashes",
      "Total Injuries (All Severities)",
      "Incapacitating Injuries",
      "Fatal Injuries",
      "Hit-and-Run Crashes",
      "Dooring Incidents"
    ),
    Count = c(
      nrow(wellington_crashes),
      sum(wellington_crashes$INJURIES_TOTAL, na.rm = TRUE),
      sum(wellington_crashes$INJURIES_INCAPACITATING, na.rm = TRUE),
      sum(wellington_crashes$INJURIES_FATAL, na.rm = TRUE),
      sum(wellington_crashes$HIT_AND_RUN_I == "Y", na.rm = TRUE),
      sum(wellington_crashes$DOORING_I == "Y", na.rm = TRUE)
    )
  )

  # Table 2: Vulnerable Road Users
  # Count crashes and people involving cyclists and pedestrians
  cyclist_people <- wellington_people %>%
    filter(simple_type == "Cyclist")

  pedestrian_people <- wellington_people %>%
    filter(simple_type == "Pedestrian")

  # Count injured (excluding "NO INDICATION OF INJURY")
  cyclist_injured <- cyclist_people %>%
    filter(!is.na(INJURY_CLASSIFICATION) &
           INJURY_CLASSIFICATION != "NO INDICATION OF INJURY") %>%
    nrow()

  pedestrian_injured <- pedestrian_people %>%
    filter(!is.na(INJURY_CLASSIFICATION) &
           INJURY_CLASSIFICATION != "NO INDICATION OF INJURY") %>%
    nrow()

  # Count unique crashes involving each type
  crashes_with_cyclists <- n_distinct(cyclist_people$CRASH_RECORD_ID)
  crashes_with_pedestrians <- n_distinct(pedestrian_people$CRASH_RECORD_ID)

  vulnerable_users_stats <- data.frame(
    Metric = c(
      "Crashes Involving Cyclists",
      "Cyclists Involved (People)",
      "Cyclists Injured",
      "Crashes Involving Pedestrians",
      "Pedestrians Involved (People)",
      "Pedestrians Injured"
    ),
    Count = c(
      crashes_with_cyclists,
      nrow(cyclist_people),
      cyclist_injured,
      crashes_with_pedestrians,
      nrow(pedestrian_people),
      pedestrian_injured
    )
  )

  # Table 3: Children in Crashes
  child_people <- wellington_people %>%
    filter(age_cohort == "Child (0-18)")

  child_injured <- child_people %>%
    filter(!is.na(INJURY_CLASSIFICATION) &
           INJURY_CLASSIFICATION != "NO INDICATION OF INJURY") %>%
    nrow()

  crashes_with_children <- n_distinct(child_people$CRASH_RECORD_ID)

  total_people <- nrow(wellington_people)
  child_percentage <- (nrow(child_people) / total_people) * 100

  children_stats <- data.frame(
    Metric = c(
      "Crashes Involving Children (0-18)",
      "Children Involved in Crashes",
      "Children Injured",
      "% of All People in Crashes Who Are Children"
    ),
    Count = c(
      crashes_with_children,
      nrow(child_people),
      child_injured,
      paste0(round(child_percentage, 1), "%")
    )
  )
}
```

### Overall Crash Summary

This table summarizes the total impact of crashes along the Wellington Avenue corridor (Data: 2019-2024).

```{r table-overall, results='asis'}
if(!is.null(wellington_people)) {
  kable(overall_stats,
        format = "html",
        align = c("l", "r"),
        col.names = c("Metric", "Count")) %>%
    kable_styling(
      bootstrap_options = c("striped", "hover", "condensed"),
      full_width = FALSE,
      position = "left"
    ) %>%
    row_spec(0, bold = TRUE, background = "#4B0082", color = "white") %>%
    row_spec(c(2, 3, 4), background = "#fff3cd") %>%  # Highlight injury rows
    column_spec(1, width = "20em") %>%
    column_spec(2, width = "8em", bold = TRUE)
}
```

### Vulnerable Road Users

Cyclists and pedestrians are particularly at risk in traffic crashes. This table shows the involvement and injury rates for these vulnerable road users (Data: 2019-2024).

```{r table-vulnerable-users, results='asis'}
if(!is.null(wellington_people)) {
  kable(vulnerable_users_stats,
        format = "html",
        align = c("l", "r"),
        col.names = c("Metric", "Count")) %>%
    kable_styling(
      bootstrap_options = c("striped", "hover", "condensed"),
      full_width = FALSE,
      position = "left"
    ) %>%
    row_spec(0, bold = TRUE, background = "#4B0082", color = "white") %>%
    row_spec(c(3, 6), background = "#f8d7da") %>%  # Highlight injury rows
    column_spec(1, width = "20em") %>%
    column_spec(2, width = "8em", bold = TRUE)
}
```

### Children in Crashes

Given the proposed Neighborhood Greenway's focus on "family-friendly" infrastructure, understanding how children are affected by crashes is critical (Data: 2019-2024).

```{r table-children, results='asis'}
if(!is.null(wellington_people)) {
  kable(children_stats,
        format = "html",
        align = c("l", "r"),
        col.names = c("Metric", "Value")) %>%
    kable_styling(
      bootstrap_options = c("striped", "hover", "condensed"),
      full_width = FALSE,
      position = "left"
    ) %>%
    row_spec(0, bold = TRUE, background = "#4B0082", color = "white") %>%
    row_spec(3, background = "#f8d7da") %>%  # Highlight injured children
    row_spec(4, background = "#d1ecf1") %>%  # Highlight percentage
    column_spec(1, width = "20em") %>%
    column_spec(2, width = "8em", bold = TRUE)
}
```

### High Injury Locations

This map shows where injuries (of any type) are most concentrated along the Wellington Avenue corridor (Data: 2019-2024).

```{r injury-hotspots, fig.width=10, fig.height=6}
# Filter for crashes with injuries
injury_crashes <- wellington_crashes %>%
  filter(INJURIES_TOTAL > 0) %>%
  st_transform(4326)

# Join with person summary data for enhanced tooltips
if(!is.null(crash_people_summary)) {
  injury_crashes <- injury_crashes %>%
    left_join(crash_people_summary, by = "CRASH_RECORD_ID")
}

wellington_streets_4326 <- st_transform(wellington_streets, 4326)

# Create enhanced tooltips
injury_crashes <- injury_crashes %>%
  mutate(
    tooltip_html = paste0(
      "<b>", format(CRASH_DATE, "%B %d, %Y"), " at ", format(CRASH_DATE, "%I:%M %p"), "</b><br>",
      "<b>Crash Type:</b> ", FIRST_CRASH_TYPE, "<br>",
      "<hr style='margin: 3px 0;'>",
      "<b>Injuries:</b> ", INJURIES_TOTAL,
      if_else(!is.na(INJURIES_FATAL) & INJURIES_FATAL > 0,
              paste0(" (", INJURIES_FATAL, " fatal)"), ""),
      if_else(!is.na(INJURIES_INCAPACITATING) & INJURIES_INCAPACITATING > 0,
              paste0(" (", INJURIES_INCAPACITATING, " incapacitating)"), ""), "<br>",
      if_else(!is.na(people_summary),
              paste0("<b>People Involved:</b> ", people_summary, "<br>"), ""),
      if_else(!is.na(age_range) & age_range != "Unknown",
              paste0("<b>Age Range:</b> ", age_range, " years<br>"), ""),
      "<hr style='margin: 3px 0;'>",
      if_else(!is.na(PRIM_CONTRIBUTORY_CAUSE) & PRIM_CONTRIBUTORY_CAUSE != "UNABLE TO DETERMINE",
              paste0("<b>Primary Cause:</b> ", PRIM_CONTRIBUTORY_CAUSE, "<br>"), ""),
      if_else(!is.na(WEATHER_CONDITION) & WEATHER_CONDITION != "UNKNOWN",
              paste0("<b>Weather:</b> ", WEATHER_CONDITION, "<br>"), ""),
      if_else(!is.na(LIGHTING_CONDITION) & LIGHTING_CONDITION != "UNKNOWN",
              paste0("<b>Lighting:</b> ", LIGHTING_CONDITION, "<br>"), ""),
      if_else(!is.na(POSTED_SPEED_LIMIT) & POSTED_SPEED_LIMIT > 0,
              paste0("<b>Speed Limit:</b> ", POSTED_SPEED_LIMIT, " mph<br>"), ""),
      if_else(!is.na(HIT_AND_RUN_I) & HIT_AND_RUN_I == "Y",
              "<b style='color: #e74c3c;'>HIT AND RUN</b><br>", "")
    )
  )

leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolylines(
    data = wellington_streets_4326,
    color = "#666666",
    weight = 3
  ) %>%
  addCircleMarkers(
    data = injury_crashes,
    radius = ~INJURIES_TOTAL * 3,
    color = "#e74c3c",
    stroke = FALSE,
    fillOpacity = 0.6,
    label = ~lapply(tooltip_html, htmltools::HTML)
  ) %>%
  addLegend(position = "bottomright", colors = "#e74c3c", labels = "Injury Crash") %>%
  setView(lng = -87.658, lat = 41.9362, zoom = 14)
```

## Cyclist Crash Locations

This map shows all crashes involving cyclists along the Wellington Avenue corridor (Data: 2019-2024).

```{r cyclist-map, fig.width=10, fig.height=6}
# Transform cyclist crashes to WGS84 for mapping
cyclist_crashes_4326 <- st_transform(cyclist_crashes, 4326)

# Join with person summary data for enhanced tooltips
if(!is.null(crash_people_summary)) {
  cyclist_crashes_4326 <- cyclist_crashes_4326 %>%
    left_join(crash_people_summary, by = "CRASH_RECORD_ID")
}

wellington_streets_4326 <- st_transform(wellington_streets, 4326)

# Create enhanced tooltips with dooring information
cyclist_crashes_4326 <- cyclist_crashes_4326 %>%
  mutate(
    tooltip_html = paste0(
      "<b>", format(CRASH_DATE, "%B %d, %Y"), " at ", format(CRASH_DATE, "%I:%M %p"), "</b><br>",
      "<b>Crash Type:</b> ", FIRST_CRASH_TYPE, "<br>",
      if_else(!is.na(DOORING_I) & DOORING_I == "Y",
              "<b style='color: #e74c3c; font-size: 14px;'>âš  DOORING INCIDENT</b><br>", ""),
      "<hr style='margin: 3px 0;'>",
      "<b>Injuries:</b> ", INJURIES_TOTAL,
      if_else(!is.na(INJURIES_FATAL) & INJURIES_FATAL > 0,
              paste0(" (", INJURIES_FATAL, " fatal)"), ""),
      if_else(!is.na(INJURIES_INCAPACITATING) & INJURIES_INCAPACITATING > 0,
              paste0(" (", INJURIES_INCAPACITATING, " incapacitating)"), ""), "<br>",
      if_else(!is.na(people_summary),
              paste0("<b>People Involved:</b> ", people_summary, "<br>"), ""),
      if_else(!is.na(age_range) & age_range != "Unknown",
              paste0("<b>Age Range:</b> ", age_range, " years<br>"), ""),
      "<hr style='margin: 3px 0;'>",
      if_else(!is.na(PRIM_CONTRIBUTORY_CAUSE) & PRIM_CONTRIBUTORY_CAUSE != "UNABLE TO DETERMINE",
              paste0("<b>Primary Cause:</b> ", PRIM_CONTRIBUTORY_CAUSE, "<br>"), ""),
      if_else(!is.na(WEATHER_CONDITION) & WEATHER_CONDITION != "UNKNOWN",
              paste0("<b>Weather:</b> ", WEATHER_CONDITION, "<br>"), ""),
      if_else(!is.na(LIGHTING_CONDITION) & LIGHTING_CONDITION != "UNKNOWN",
              paste0("<b>Lighting:</b> ", LIGHTING_CONDITION, "<br>"), ""),
      if_else(!is.na(POSTED_SPEED_LIMIT) & POSTED_SPEED_LIMIT > 0,
              paste0("<b>Speed Limit:</b> ", POSTED_SPEED_LIMIT, " mph<br>"), ""),
      if_else(!is.na(HIT_AND_RUN_I) & HIT_AND_RUN_I == "Y",
              "<b style='color: #e74c3c;'>HIT AND RUN</b><br>", "")
    )
  )

# Create cyclist crash map
cyclist_map <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolylines(
    data = wellington_streets_4326,
    color = "#666666",
    weight = 3,
    label = "Wellington Avenue"
  ) %>%
  addCircleMarkers(
    data = cyclist_crashes_4326,
    radius = 5,
    color = "#e74c3c",
    fillColor = "#e74c3c",
    fillOpacity = 0.7,
    stroke = TRUE,
    weight = 1,
    label = ~lapply(tooltip_html, htmltools::HTML)
  ) %>%
  addLegend(
    position = "bottomright",
    colors = "#e74c3c",
    labels = "Cyclist Crash",
    title = "Legend"
  ) %>%
  setView(lng = -87.6505, lat = 41.9362, zoom = 14)

cyclist_map
```

## Pedestrian Crash Locations

This map shows all crashes involving pedestrians along the Wellington Avenue corridor (Data: 2019-2024).

```{r pedestrian-map, fig.width=10, fig.height=6}
# Transform pedestrian crashes to WGS84 for mapping
pedestrian_crashes_4326 <- st_transform(pedestrian_crashes, 4326)

# Join with person summary data for enhanced tooltips
if(!is.null(crash_people_summary)) {
  pedestrian_crashes_4326 <- pedestrian_crashes_4326 %>%
    left_join(crash_people_summary, by = "CRASH_RECORD_ID")
}

# Create enhanced tooltips
pedestrian_crashes_4326 <- pedestrian_crashes_4326 %>%
  mutate(
    tooltip_html = paste0(
      "<b>", format(CRASH_DATE, "%B %d, %Y"), " at ", format(CRASH_DATE, "%I:%M %p"), "</b><br>",
      "<b>Crash Type:</b> ", FIRST_CRASH_TYPE, "<br>",
      "<hr style='margin: 3px 0;'>",
      "<b>Injuries:</b> ", INJURIES_TOTAL,
      if_else(!is.na(INJURIES_FATAL) & INJURIES_FATAL > 0,
              paste0(" (", INJURIES_FATAL, " fatal)"), ""),
      if_else(!is.na(INJURIES_INCAPACITATING) & INJURIES_INCAPACITATING > 0,
              paste0(" (", INJURIES_INCAPACITATING, " incapacitating)"), ""), "<br>",
      if_else(!is.na(people_summary),
              paste0("<b>People Involved:</b> ", people_summary, "<br>"), ""),
      if_else(!is.na(age_range) & age_range != "Unknown",
              paste0("<b>Age Range:</b> ", age_range, " years<br>"), ""),
      "<hr style='margin: 3px 0;'>",
      if_else(!is.na(PRIM_CONTRIBUTORY_CAUSE) & PRIM_CONTRIBUTORY_CAUSE != "UNABLE TO DETERMINE",
              paste0("<b>Primary Cause:</b> ", PRIM_CONTRIBUTORY_CAUSE, "<br>"), ""),
      if_else(!is.na(WEATHER_CONDITION) & WEATHER_CONDITION != "UNKNOWN",
              paste0("<b>Weather:</b> ", WEATHER_CONDITION, "<br>"), ""),
      if_else(!is.na(LIGHTING_CONDITION) & LIGHTING_CONDITION != "UNKNOWN",
              paste0("<b>Lighting:</b> ", LIGHTING_CONDITION, "<br>"), ""),
      if_else(!is.na(POSTED_SPEED_LIMIT) & POSTED_SPEED_LIMIT > 0,
              paste0("<b>Speed Limit:</b> ", POSTED_SPEED_LIMIT, " mph<br>"), ""),
      if_else(!is.na(INTERSECTION_RELATED_I) & INTERSECTION_RELATED_I == "Y",
              "<b>Location:</b> Intersection-related<br>", ""),
      if_else(!is.na(HIT_AND_RUN_I) & HIT_AND_RUN_I == "Y",
              "<b style='color: #e74c3c;'>HIT AND RUN</b><br>", "")
    )
  )

# Create pedestrian crash map
pedestrian_map <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolylines(
    data = wellington_streets_4326,
    color = "#666666",
    weight = 3,
    label = "Wellington Avenue"
  ) %>%
  addCircleMarkers(
    data = pedestrian_crashes_4326,
    radius = 5,
    color = "#3498db",
    fillColor = "#3498db",
    fillOpacity = 0.7,
    stroke = TRUE,
    weight = 1,
    label = ~lapply(tooltip_html, htmltools::HTML)
  ) %>%
  addLegend(
    position = "bottomright",
    colors = "#3498db",
    labels = "Pedestrian Crash",
    title = "Legend"
  ) %>%
  setView(lng = -87.6505, lat = 41.9362, zoom = 14)

pedestrian_map
```

## Crash Clusters

This heat map visualization shows where crashes are concentrated along the Wellington Avenue corridor (Data: 2019-2024).

```{r crash-clusters, fig.width=10, fig.height=6}
# Transform crashes to WGS84 for mapping
wellington_crashes_4326 <- st_transform(wellington_crashes, 4326)

# Create hex grid for crash clustering
bbox_utm <- st_transform(st_as_sfc(st_bbox(wellington_crashes_4326)), 26916)

hex_grid <- st_make_grid(
  bbox_utm,
  cellsize = c(150, 150),  # 150 meter hexagons
  square = FALSE
) %>%
  st_sf() %>%
  st_transform(4326)

# Calculate crash counts per hexagon
hex_sf <- hex_grid %>%
  mutate(
    count = lengths(st_intersects(., wellington_crashes_4326)),
    total_injuries = sapply(st_intersects(., wellington_crashes_4326), function(idx) {
      sum(wellington_crashes_4326$INJURIES_TOTAL[idx], na.rm = TRUE)
    })
  ) %>%
  filter(count > 0)

# Color palette
pal <- colorNumeric(
  palette = "YlOrRd",
  domain = hex_sf$count
)

# Create the map
cluster_map <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolylines(
    data = wellington_streets_4326,
    color = "#666666",
    weight = 3,
    label = "Wellington Avenue"
  ) %>%
  addPolygons(
    data = hex_sf,
    fillColor = ~pal(count),
    fillOpacity = 0.7,
    color = "#FFFFFF",
    weight = 1,
    label = ~sprintf(
      "%d crashes<br>%d injuries",
      count,
      total_injuries
    ) %>% lapply(htmltools::HTML),
    highlightOptions = highlightOptions(
      weight = 2,
      color = "#666",
      fillOpacity = 0.9,
      bringToFront = TRUE
    )
  ) %>%
  addLegend(
    position = "bottomright",
    pal = pal,
    values = hex_sf$count,
    title = "Crash Count",
    opacity = 0.7
  ) %>%
  setView(lng = -87.6505, lat = 41.9362, zoom = 14)

cluster_map
```
